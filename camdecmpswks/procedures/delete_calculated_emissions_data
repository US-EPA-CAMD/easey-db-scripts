CREATE OR REPLACE PROCEDURE camdecmpswks.delete_calculated_emissions_data (
	monplanid varchar,
	reportperiod integer,
	INOUT p_V_RESULT text, 
	INOUT p_V_ERROR_MSG varchar
	)
AS $$
BEGIN

	-- Expected XML structure is
	-- <MonitoringPlans>
	--   <MonitoringPlan MON_PLAN_ID="MDC-50103043449C4E92A6CC2A279C52F874" RPT_PERIOD_ID="68" />
	--   <MonitoringPlan MON_PLAN_ID="MDC-1CDDECD122944982AAA7B3376CC4D80A" RPT_PERIOD_ID="66" />
	-- </MonitoringPlans>
	
	CREATE TEMPORARY TABLE tmp_MonLocIDs ( MON_PLAN_ID DB_ID_KEY, MON_LOC_ID DB_ID_KEY, RPT_PERIOD_ID ID_KEY );
	
	BEGIN
		p_V_RESULT := 'T';
		p_V_ERROR_MSG := '';

		-- Get all the MON_LOC_IDs for this MP
		
		INSERT INTO tmp_MonLocIDs( MON_PLAN_ID, MON_LOC_ID, RPT_PERIOD_ID )
			SELECT MPs.MON_PLAN_ID, mpl.MON_LOC_ID, MPs.RPT_PERIOD_ID
			FROM camdecmpswks.MONITOR_PLAN_LOCATION mpl
				INNER JOIN ( SELECT monplanid as MON_PLAN_ID, 
									reportperiod as RPT_PERIOD_ID 
							) as MPs
				 on mpl.MON_PLAN_ID = MPs.MON_PLAN_ID;


		-- Delete the check session for this MP/RPT Period
		DELETE FROM camdecmpswks.CHECK_SESSION 
		WHERE CHK_SESSION_ID IN (	SELECT CHK_SESSION_ID 
									FROM camdecmpswks.EMISSION_EVALUATION ee
										INNER JOIN ( SELECT monplanid as MON_PLAN_ID, 
															reportperiod as RPT_PERIOD_ID 
													
													) as MPs
										   on ee.MON_PLAN_ID=MPs.MON_PLAN_ID and ee.RPT_PERIOD_ID=MPs.RPT_PERIOD_ID
									WHERE ee.CHK_SESSION_ID IS NOT NULL );

		-- Clear the eval
		UPDATE ee SET NEEDS_EVAL_FLG = 'Y',
			CHK_SESSION_ID = null
		FROM camdecmpswks.EMISSION_EVALUATION ee
			INNER JOIN ( SELECT monplanid as MON_PLAN_ID, 
								reportperiod as RPT_PERIOD_ID 
						
						) as MPs
			   on ee.MON_PLAN_ID=MPs.MON_PLAN_ID and ee.RPT_PERIOD_ID=MPs.RPT_PERIOD_ID;
		
		--
		-- Now, clear all the calculated fields on the 
		--
		
		UPDATE DC SET CALC_ONLINE_OFFLINE_IND = null,
			CALC_ZERO_APS_IND = null,
			CALC_ZERO_CAL_ERROR = null,
			CALC_UPSCALE_APS_IND = null,
			CALC_UPSCALE_CAL_ERROR = null
		FROM camdecmpswks.DAILY_CALIBRATION DC
			INNER JOIN camdecmpswks.DAILY_TEST_SUMMARY DTS on DC.DAILY_TEST_SUM_ID = DTS.DAILY_TEST_SUM_ID 
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = dts.MON_LOC_ID and ml.RPT_PERIOD_ID=dts.RPT_PERIOD_ID;

		UPDATE dts SET CALC_TEST_RESULT_CD = null
		FROM camdecmpswks.DAILY_TEST_SUMMARY dts
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = dts.MON_LOC_ID and ml.RPT_PERIOD_ID=dts.RPT_PERIOD_ID;

		UPDATE dhv SET CALC_UNADJUSTED_HRLY_VALUE = null,
			CALC_ADJUSTED_HRLY_VALUE = null,
			APPLICABLE_BIAS_ADJ_FACTOR = null,
			CALC_RATA_STATUS = null,
			CALC_APPE_STATUS = null
		FROM camdecmpswks.DERIVED_HRLY_VALUE dhv
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = dhv.MON_LOC_ID and ml.RPT_PERIOD_ID=dhv.RPT_PERIOD_ID;

		UPDATE mhv SET CALC_ADJUSTED_HRLY_VALUE = null,
			APPLICABLE_BIAS_ADJ_FACTOR = null,
			CALC_LINE_STATUS = null,
			CALC_RATA_STATUS = null,
			CALC_DAYCAL_STATUS = null
		FROM camdecmpswks.MONITOR_HRLY_VALUE mhv
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = mhv.MON_LOC_ID and ml.RPT_PERIOD_ID=mhv.RPT_PERIOD_ID;

		UPDATE sv SET CALC_CURRENT_RPT_PERIOD_TOTAL = null,
			CALC_YEAR_TOTAL = null,		
			CALC_OS_TOTAL = null
		FROM camdecmpswks.SUMMARY_VALUE sv
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = sv.MON_LOC_ID and ml.RPT_PERIOD_ID=sv.RPT_PERIOD_ID;

		UPDATE hff SET CALC_VOLUMETRIC_FLOW_RATE = null,
			CALC_MASS_FLOW_RATE = null,
			CALC_APPD_STATUS = null
		FROM camdecmpswks.HRLY_FUEL_FLOW hff
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = hff.MON_LOC_ID and ml.RPT_PERIOD_ID=hff.RPT_PERIOD_ID;

		UPDATE hpff SET CALC_PARAM_VAL_FUEL = null,
			CALC_APPE_STATUS = null
		FROM camdecmpswks.HRLY_PARAM_FUEL_FLOW hpff
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = hpff.MON_LOC_ID and ml.RPT_PERIOD_ID=hpff.RPT_PERIOD_ID;

		UPDATE ltff SET CALC_TOTAL_HEAT_INPUT = null
		FROM camdecmpswks.LONG_TERM_FUEL_FLOW ltff
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = ltff.MON_LOC_ID and ml.RPT_PERIOD_ID=ltff.RPT_PERIOD_ID;

		-- RGGI field
		UPDATE de SET CALC_TOTAL_DAILY_EMISSION = null
		FROM camdecmpswks.DAILY_EMISSION de
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = de.MON_LOC_ID and ml.RPT_PERIOD_ID=de.RPT_PERIOD_ID;

		-- RGGI table/field
		UPDATE df SET CALC_FUEL_CARBON_BURNED = null
		FROM camdecmpswks.DAILY_FUEL df
			INNER JOIN camdecmpswks.DAILY_EMISSION de on df.DAILY_EMISSION_ID = de.DAILY_EMISSION_ID
			INNER JOIN tmp_MonLocIDs ml on ml.MON_LOC_ID = de.MON_LOC_ID and ml.RPT_PERIOD_ID=de.RPT_PERIOD_ID;

		-- Delete rows for DM_EMISSIONS and its child tables
		--DELETE 
		--FROM DmEm.DM_EMISSIONS
		--WHERE DM_EMISSIONS_ID IN ( SELECT DM_EMISSIONS_ID 
		--						   FROM DmEm.DM_EMISSIONS de
		--								INNER JOIN tmp_MonLocIDs ml on ml.MON_PLAN_ID = de.MON_PLAN_ID and ml.RPT_PERIOD_ID=de.RPT_PERIOD_ID 
		--						 );
		--
		--Remove error codes and calculated values from pre-rendered View Emissions tables.
		--
		Call camdecmpswks.emissions_grid_remove_eval(monplanid, p_v_RESULT, p_V_ERROR_MSG);
	EXCEPTION WHEN OTHERS THEN
		p_V_ERROR_MSG := ERROR_PROCEDURE() || ': ' || ERROR_MESSAGE() || ' (' || cast(ERROR_LINE() as varchar(10)) || ')';
		p_V_RESULT := 'F';
	END;
END;
$$ LANGUAGE plpgsql;
